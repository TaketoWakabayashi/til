<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="440" height="400"></svg>

<script>

    // The svg
    const svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    // Map and projection
    const projection = d3.geoMercator()
        .scale(1000)
        .center([137, 38])
        .translate([width / 2, height / 2])

    // A path generator
    const path = d3.geoPath()
        .projection(projection)

    // Load Japan geo shape AND list of connection
    Promise.all([
        d3.json("./japan.geojson"),  // Japan geo shape
        d3.csv("./data_connectionmap.csv") // Position of connection
    ]).then(

        function (initialize) {

            let dataGeo = initialize[0]
            let data = initialize[1]

            // Reformat the list of link. Note that columns in csv file are called long1, long2, lat1, lat2
            const link = []
            data.forEach(function (row) {
                source = [+row.long1, +row.lat1]
                target = [+row.long2, +row.lat2]
                topush = { type: "LineString", coordinates: [source, target] }
                link.push(topush)
            })

            // Draw the map
            svg.append("g")
                .selectAll("path")
                .data(dataGeo.features)
                .join("path")
                .attr("fill", "#b8b8b8")
                .attr("d", path)
                .style("stroke", "#fff")
                .style("stroke-width", 0)

            // Add the path
            /*
                        svg.selectAll("myPath")
                            .data(link)
                            .join("path")
                            .attr("d", function (d) {
                                return path(d)
                            })
                            .style("fill", "none")
                            .style("stroke", "#e73750")
                            .style("stroke-width", 7)
            */


            svg.selectAll("myPath")
                .data(link)
                .enter()
                .append("path")
                .transition()
                .delay(1000)
                .attr("d", function (d) {
                    return path(d)
                })
                .style("fill", "none")
                .style("stroke", "orange")
                .style("stroke-width", 2)

            /*
        link.forEach(function (row) {
            svg.selectAll("myPath")
                .append("path")
                .attr("d", path(row))
                .style("fill", "none")
                .style("stroke", "#e73750")
                .style("stroke-width", 7)
        })*/

            /*
            .transition()
            .duration(500)
            .delay(500)*/
        })
</script>